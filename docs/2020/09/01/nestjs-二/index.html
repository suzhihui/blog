<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>nextjs(二) | 日不新，则日退</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="RESTful API的设计指南一、参考文档二、常见的请求方式 1、请求方式对比     请求方式 说明    GET请求 从服务器取出资源（一项或多项）   POST请求 在服务器新建一个资源   PUT请求 在服务器更新资源（客户端提供改变后的完整资源）   PATCH请求 在服务器更新资源（客户端提供改变的属性）   DELETE请求 从服务器删除资源    2、区分PUT和PATCH 1、">
<meta property="og:type" content="article">
<meta property="og:title" content="nextjs(二)">
<meta property="og:url" content="https://suzhihui.github.io/2020/09/01/nestjs-%E4%BA%8C/index.html">
<meta property="og:site_name" content="日不新，则日退">
<meta property="og:description" content="RESTful API的设计指南一、参考文档二、常见的请求方式 1、请求方式对比     请求方式 说明    GET请求 从服务器取出资源（一项或多项）   POST请求 在服务器新建一个资源   PUT请求 在服务器更新资源（客户端提供改变后的完整资源）   PATCH请求 在服务器更新资源（客户端提供改变的属性）   DELETE请求 从服务器删除资源    2、区分PUT和PATCH 1、">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://images.gitee.com/uploads/images/2020/0831/201855_084c9f0f_1808543.jpeg">
<meta property="article:published_time" content="2020-09-01T12:59:08.000Z">
<meta property="article:modified_time" content="2020-10-19T11:45:29.445Z">
<meta property="article:author" content="laosu">
<meta property="article:tag" content="nestjs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.gitee.com/uploads/images/2020/0831/201855_084c9f0f_1808543.jpeg">
  
    <link rel="alternate" href="/atom.xml" title="日不新，则日退" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">日不新，则日退</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">海纳百川</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://suzhihui.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-nestjs-二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/01/nestjs-%E4%BA%8C/" class="article-date">
  <time datetime="2020-09-01T12:59:08.000Z" itemprop="datePublished">2020-09-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      nextjs(二)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RESTful-API的设计指南"><a href="#RESTful-API的设计指南" class="headerlink" title="RESTful API的设计指南"></a><center><code>RESTful API</code>的设计指南</center></h1><h2 id="一、参考文档"><a href="#一、参考文档" class="headerlink" title="一、参考文档"></a>一、<a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">参考文档</a></h2><h2 id="二、常见的请求方式"><a href="#二、常见的请求方式" class="headerlink" title="二、常见的请求方式"></a>二、常见的请求方式</h2><ul>
<li>1、请求方式对比</li>
</ul>
<table>
<thead>
<tr>
<th>请求方式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>GET</code>请求</td>
<td>从服务器取出资源（一项或多项）</td>
</tr>
<tr>
<td><code>POST</code>请求</td>
<td>在服务器新建一个资源</td>
</tr>
<tr>
<td><code>PUT</code>请求</td>
<td>在服务器更新资源（客户端提供改变后的完整资源）</td>
</tr>
<tr>
<td><code>PATCH</code>请求</td>
<td>在服务器更新资源（客户端提供改变的属性）</td>
</tr>
<tr>
<td><code>DELETE</code>请求</td>
<td>从服务器删除资源</td>
</tr>
</tbody></table>
<ul>
<li>2、区分<code>PUT</code>和<code>PATCH</code><ul>
<li>1、两个请求方式都是向服务器发送修改数据的请求</li>
<li>2、<code>PUT</code>可以理解为彻底全部的更新数据</li>
<li>3、<code>PATCH</code>可以理解为打补丁,就是更新数据的一部分<font color="#f00">(也是我们比较常用的方式)</font></li>
</ul>
</li>
</ul>
<h2 id="三、设计接口规范-对阮一峰文档的补充"><a href="#三、设计接口规范-对阮一峰文档的补充" class="headerlink" title="三、设计接口规范(对阮一峰文档的补充)"></a>三、设计接口规范(对阮一峰文档的补充)</h2><blockquote>
<p>认真看下阮一峰文章里面对日常<code>RESTful API</code>开发,会对其了解,我相信也能写出符合标准的<code>RESTful API</code>接口,但是我还是要补充一点</p>
</blockquote>
<ul>
<li><p>1、对于增删改查严格使用<code>GET</code>、<code>POST</code>、<code>PATCH</code>、<code>DELETE</code>的请求方式,不要清一色的使用<code>GET</code>和<code>POST</code>请求</p>
</li>
<li><p>2、上面不管是<code>GET</code>、<code>POST</code>、<code>PATCH</code>、<code>DELETE</code>都表示一个动作(所谓的动词)</p>
</li>
<li><p>3、我们在设计<code>API</code>的时候就不要在出现<strong>动词</strong>了,比如<code>xxx/api/v1/get_user</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xxx/api/v1/get_user <span class="comment">// 不好的接口设计 get请求 在url中使用了get这个动词</span></span><br><span class="line">xxx/api/v1/save <span class="comment">// 不好的接口设计 post请求 提交数据,在url中出现动词save</span></span><br><span class="line"></span><br><span class="line">xxx/api/v1/user <span class="comment">//get请求 表示获取用户列表,返回是一个数组</span></span><br><span class="line">xxx/api/v1/user/<span class="number">1</span> <span class="comment">//get请求 表示获取用户信息,返回一个对象</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>4、一般我们的<code>url</code>地址都是使用下划线命名的方式,不使用小驼峰命名方式</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx/api/v1/modifyPassword <span class="comment">// 不要使用小驼峰命名,url选用下划线的方式</span></span><br></pre></td></tr></table></figure>

<h2 id="一、服务器端接收客户端传递的参数的几种方式"><a href="#一、服务器端接收客户端传递的参数的几种方式" class="headerlink" title="一、服务器端接收客户端传递的参数的几种方式"></a>一、服务器端接收客户端传递的参数的几种方式</h2></li>
<li><p>1、<code>POST</code>、<code>PATCH</code>请求体中发送的数据(最常见)</p>
</li>
<li><p>2、<code>GET</code>请求的<code>query</code>参数方式</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx/api/v1/user?pageSize=<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>3、<code>GET</code>、<code>PATCH</code>、<code>DELETE</code>请求的<code>params</code>的参数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx/api/v1/user/<span class="number">1</span> <span class="comment">// 获取用户id=1的数据</span></span><br></pre></td></tr></table></figure></li>
<li><p>4、请求头的数据,常见的<code>token</code></p>
</li>
</ul>
<h2 id="二、在Nestjs中接收浏览器上的参数"><a href="#二、在Nestjs中接收浏览器上的参数" class="headerlink" title="二、在Nestjs中接收浏览器上的参数"></a>二、在<code>Nestjs</code>中接收浏览器上的参数</h2><ul>
<li>1、常见的方法列表</li>
</ul>
<table>
<thead>
<tr>
<th align="center">No.</th>
<th>名字</th>
<th>字段说明(参考<code>express</code>框架字段)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td><code>@Request()</code></td>
<td><code>req</code> 获取到req请求的参数</td>
</tr>
<tr>
<td align="center">2</td>
<td><code>@Response()</code></td>
<td><code>res</code> 使用了res就不使用使用return返回值需要使用res.send()</td>
</tr>
<tr>
<td align="center">3</td>
<td><code>@Next()</code></td>
<td>next</td>
</tr>
<tr>
<td align="center">4</td>
<td><code>@Session()</code></td>
<td><code>req.</code>session</td>
</tr>
<tr>
<td align="center">5</td>
<td><code>@Param(key?: string)</code></td>
<td><code>req.params</code> / <code>req.params[key]</code> 获取动态路由的参数</td>
</tr>
<tr>
<td align="center">6</td>
<td><code>@Body(key?: string)</code></td>
<td><code>req.body</code> / <code>req.body[key]</code> 获取post请求提交的参数</td>
</tr>
<tr>
<td align="center">7</td>
<td><code>@Query(key?: string)</code></td>
<td><code>req.query</code> / <code>req.query[key]</code> 获取get请求query的参数</td>
</tr>
<tr>
<td align="center">8</td>
<td><code>@Headers(name?: string)</code></td>
<td><code>req.headers</code> / <code>req.headers[name]</code> 获取请求头的参数</td>
</tr>
</tbody></table>
<ul>
<li><p>2、关于<code>@Query()</code>获取全部的参数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="comment">// 批量获取全部的参数,接收到的是一个对象,你传递什么我就接收什么</span></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  userList(</span><br><span class="line">    <span class="meta">@Query</span>() query: <span class="built_in">any</span></span><br><span class="line">  ): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(query);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'用户列表'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 浏览器访问的url地址:http://localhost:3000/user?name=hello&amp;age=20</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>3、选择性接收<code>Query()</code>中带参数并且判断参数类型</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="comment">// 只接收全部参数里面的其中一个或者多个,ParseIntPipe是nestjs中内置管道</span></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  userList(</span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">'age'</span>, <span class="keyword">new</span> ParseIntPipe()) age: <span class="built_in">number</span>,</span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">'name'</span>) name: <span class="built_in">string</span></span><br><span class="line">  ): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="comment">// 我只要age和name字段,别的你传递多的给我，我也不接收也不处理</span></span><br><span class="line">    <span class="built_in">console</span>.log(age, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'用户列表'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 浏览器访问的url地址:http://localhost:3000/user?name=hello&amp;age=20</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>4、<code>@Param</code>参数的获取</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">":id"</span>)</span><br><span class="line">userInfo(</span><br><span class="line">  <span class="meta">@Param</span>() params:<span class="built_in">any</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(params); <span class="comment">// 输出&#123; id: '2' &#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"用户详情"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 浏览器访问的url地址:http://localhost:3000/user/2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>5、<code>@Param</code>单独接受参数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">":id"</span>)</span><br><span class="line">userInfo(</span><br><span class="line">  <span class="meta">@Param</span>(<span class="string">'id'</span>, <span class="keyword">new</span> ParseIntPipe()) id: <span class="built_in">number</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(id);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"用户详情"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 浏览器访问的url地址:http://localhost:3000/user/2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>6、<code>@Body()</code>接受<code>post</code>提交过来的数据(一次性接收全部的,也可以在<code>@Body()</code>中加参数类似上面的方式一样的校验传递过来的参数[仅仅是针对参数比较少的情况下])</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line">addUser(</span><br><span class="line">  <span class="meta">@Body</span>() body: <span class="built_in">any</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 这种写法适合大规模的提交参数,自己又不想一个一个去校验</span></span><br><span class="line">  <span class="built_in">console</span>.log(body);</span><br><span class="line">  <span class="keyword">return</span> body</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用postman提交post请求地址:http://localhost:3000/user/</span></span><br></pre></td></tr></table></figure></li>
<li><p>7、<a href="https://github.com/kuangshp/nest-book-code/tree/06.params" target="_blank" rel="noopener">参考代码</a></p>
</li>
</ul>
<h2 id="三、注意点-个人建议"><a href="#三、注意点-个人建议" class="headerlink" title="三、注意点(个人建议)"></a>三、注意点(<font color="#f00">个人建议</font>)</h2><p>我们在写控制层和服务层的时候劲量遵循增删改查的顺序来写,这样方便以后查找代码比较方便,方便直接定位到哪里</p>
<h3 id="一、关于前端模板引擎的介绍"><a href="#一、关于前端模板引擎的介绍" class="headerlink" title="一、关于前端模板引擎的介绍"></a>一、关于前端模板引擎的介绍</h3><p>现在如果是面向多端开发的模式下,会进行前后端分离式的方式进行开发,一般用<code>nestjs</code>直接返回<code>api</code>接口,前端用<code>angular</code>、<code>react</code>、<code>vue</code>去做的,如果不考虑做多端开发,快速点可以直接在<code>nestjs</code>写前端模板,类似我们比较传统的<code>java</code>开发中,使用<code>jsp</code>模板来渲染前端页面。根据项目具体情况选择该技术栈</p>
<h2 id="二、在Nestjs中自己配置ejs模板"><a href="#二、在Nestjs中自己配置ejs模板" class="headerlink" title="二、在Nestjs中自己配置ejs模板"></a>二、在<code>Nestjs</code>中自己配置<code>ejs</code>模板</h2><ul>
<li><p>1、<a href="https://docs.nestjs.com/techniques/mvc" target="_blank" rel="noopener">官网地址</a></p>
</li>
<li><p>2、安装模板引擎包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ejs --save</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、在<code>main.ts</code>中配置</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dotenv/config'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Logger &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="comment">// 引入包</span></span><br><span class="line"><span class="keyword">import</span> &#123; NestExpressApplication &#125; <span class="keyword">from</span> <span class="string">'@nestjs/platform-express'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = process.env.PORT || <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create&lt;NestExpressApplication&gt;(AppModule);</span><br><span class="line">  <span class="comment">// 配置静态文件的目录</span></span><br><span class="line">  <span class="comment">//方式一是直接访问:localhost:4000/1.jpg</span></span><br><span class="line">  <span class="comment">//app.useStaticAssets(join(__dirname, '..', 'public')); </span></span><br><span class="line">  <span class="comment">//方式二是访问:localhost:4000/static/1.jpg但是在public文件夹下不需要创建static目录</span></span><br><span class="line">  app.useStaticAssets(join(__dirname, <span class="string">'..'</span>, <span class="string">'public'</span>), &#123;</span><br><span class="line">  		prefix: <span class="string">'/static/'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 配置视图文件的目录</span></span><br><span class="line">  app.setBaseViewsDir(join(__dirname, <span class="string">'..'</span>, <span class="string">'views'</span>)); </span><br><span class="line">  app.setViewEngine(<span class="string">'ejs'</span>);</span><br><span class="line">  <span class="keyword">await</span> app.listen(PORT, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    Logger.log(<span class="string">`服务已经启动,请访问:http://wwww.localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、在项目的根目录下创建<code>public</code>和<code>views</code>的目录</p>
</li>
<li><p>4、测试<code>views</code>文件夹下创建一个<code>index.ejs</code>文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>5、控制器中使用<code>@Render</code>渲染模板</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Render &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppController &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="meta">@Render</span>(<span class="string">'index'</span>)</span><br><span class="line">  getHello(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; name: <span class="string">'哈哈'</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>6、在浏览器上输入<code>localhost:3000</code>查看结果</p>
</li>
</ul>
<h2 id="三、测试访问静态目录文件"><a href="#三、测试访问静态目录文件" class="headerlink" title="三、测试访问静态目录文件"></a>三、测试访问静态目录文件</h2><ul>
<li><p>1、在<code>public</code>中创建<code>css</code>、<code>js</code>、<code>images</code>文件夹</p>
</li>
<li><p>2、在<code>index.ejs</code>模板中使用样式、<code>js</code>、图片</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"/static/css/index.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/static/images/dog.jpg"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/js/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">'h1'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      alert(<span class="string">'点击了我'</span>);</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="四、模板数据渲染"><a href="#四、模板数据渲染" class="headerlink" title="四、模板数据渲染"></a>四、模板数据渲染</h2><p>在远古时代的前端开发或者叫页面仔的时代，前端开发把静态页面写好了，发给后端的同学(java,php)他们使用模板不同的模板引擎，在前端静态页面中把需要显示从数据库获取的数据的地方使用特殊的符合，动态的显示数据。</p>
<ul>
<li><p>1、被处理的前端模板,等待后端数据反填上去</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=title%</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=title%</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/user/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2、在<code>Nestjs</code>中渲染前端模板及返回数据</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Render, Post, Body, Response &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  index() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'主页'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">'login'</span>)</span><br><span class="line">  <span class="meta">@Render</span>(<span class="string">'login'</span>) <span class="comment">// 渲染views里面的ejs模板</span></span><br><span class="line">  loginPage() &#123;</span><br><span class="line">    <span class="comment">// 这里的数据到时候讲到数据库，服务层的时候直接从数据库拉取数据,现在先写个假数据</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="string">'title'</span>: <span class="string">'登录页面'</span> &#125; <span class="comment">// 返回给ejs模板的数据</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">'login'</span>)</span><br><span class="line">  login(<span class="meta">@Body</span>() body, <span class="meta">@Response</span>() res) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(body); <span class="comment">// 获取表单中提交的数据</span></span><br><span class="line">    res.redirect(<span class="string">'/user'</span>); <span class="comment">// 重定向到用户首页</span></span><br><span class="line">    <span class="comment">// 注意如果在控制器函数中使用了@Response()就不能使用return返回值</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、在浏览器上直接访问<code>localhost:3000/user/login</code></p>
</li>
<li><p>4、<a href="https://github.com/kuangshp/nest-book-code/tree/07.ejs" target="_blank" rel="noopener">本章节代码</a></p>
</li>
</ul>
<h2 id="一、Cookie的介绍"><a href="#一、Cookie的介绍" class="headerlink" title="一、Cookie的介绍"></a>一、<code>Cookie</code>的介绍</h2><ul>
<li>1、<code>HTTP</code> 是无状态协议。简单地说，当你浏览了一个页面,然后转到同一个网站的另一个页 面，服务器无法认识到这是同一个浏览器在访问同一个网站。每一次的访问，都是没有任何关系的。如果我们要实现多个页面之间共享数据的话我们就可以使用 <code>Cookie</code> 或者 <code>Session</code> 实 现</li>
<li>2、<code>cookie</code> 是存储于访问者的计算机中的变量。可以让我们用同一个浏览器访问同一个域名的时候共享数据。</li>
</ul>
<h2 id="二、Cookie的特点"><a href="#二、Cookie的特点" class="headerlink" title="二、Cookie的特点"></a>二、<code>Cookie</code>的特点</h2><ul>
<li><code>cookie</code> 保存在浏览器本地</li>
<li>正常设置的 <code>cookie</code> 是不加密的，用户可以自由看到;</li>
<li>用户可以删除 <code>cookie</code>，或者禁用它</li>
<li><code>cookie</code> 可以被篡改</li>
<li><code>cookie</code> 可以用于攻击</li>
<li><code>cookie</code> 存储量很小。实际上要被<code>localStorage</code>替代，但是后者 IE9 兼容。</li>
</ul>
<h2 id="三、在Nestjs中使用Cookie"><a href="#三、在Nestjs中使用Cookie" class="headerlink" title="三、在Nestjs中使用Cookie"></a>三、在<code>Nestjs</code>中使用<code>Cookie</code></h2><ul>
<li><p>1、<a href="https://www.npmjs.com/package/cookie-parser" target="_blank" rel="noopener"><code>cookie-parser</code>地址</a></p>
</li>
<li><p>2、下载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install cookie-parser</span><br><span class="line">npm install @types/cookie-parser -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、在<code>main.ts</code>中使用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导包</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cookieParser <span class="keyword">from</span> <span class="string">'cookie-parser'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">  <span class="comment">// 使用</span></span><br><span class="line">  app.use(cookieParser());</span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>
</li>
<li><p>4、在组件的控制器中写入和获取<code>cookie</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Response, Request &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  index(<span class="meta">@Request</span>() req) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.cookies.name, <span class="string">'当前的cookie'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'主页'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">'login'</span>)</span><br><span class="line">  login(<span class="meta">@Response</span>() res) &#123;</span><br><span class="line">    <span class="comment">// 如果使使用了res就不能使用return，必须使用send</span></span><br><span class="line">    res.cookie(<span class="string">'name'</span>, <span class="string">'hello'</span>, &#123; maxAge: <span class="number">1000</span> * <span class="number">5</span>, httpOnly: <span class="literal">true</span> &#125;);</span><br><span class="line">    res.send(<span class="string">'登录页面'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>5、在浏览器控制图查看<code>cookie</code></p>
<blockquote>
<p>到了时间刷新浏览器控制图上的刷新的,<code>cookie</code>就会被清空的</p>
</blockquote>
<p><img src="https://images.gitee.com/uploads/images/2020/0831/201855_084c9f0f_1808543.jpeg" alt="输入图片说明" title="nestjs03_cookie.jpg"></p>
</li>
</ul>
<ul>
<li>6、关于<code>cookie</code>的参数说明</li>
</ul>
<table>
<thead>
<tr>
<th align="center">NO.</th>
<th align="left">参数</th>
<th>类型</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="left"><code>domain</code></td>
<td><code>String</code></td>
<td>指定域名下有效</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left"><code>expires</code></td>
<td><code>Date</code></td>
<td>过期时间(秒),设置在某个时间点后会在该<code>cookoe</code>后失效</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left"><code>httpOnly</code></td>
<td><code>Boolean</code></td>
<td>默认为<code>false</code>表示不允许客户端(通过<code>js</code>来获取<code>cookie</code>)</td>
</tr>
<tr>
<td align="center">4</td>
<td align="left"><code>maxAge</code></td>
<td><code>String</code></td>
<td>最大失效时间(毫秒),设置在多少时间后失效</td>
</tr>
<tr>
<td align="center">5</td>
<td align="left"><code>path</code></td>
<td><code>String</code></td>
<td>表示<code>cookie</code>影响到的路径,如:<code>path=/</code>如果路径不能匹配的时候,浏览器则不发送这个<code>cookie</code></td>
</tr>
<tr>
<td align="center">6</td>
<td align="left"><code>secure</code></td>
<td><code>Boolean</code></td>
<td>当 <code>secure</code> 值为<code>true</code> 时,<code>cookie</code> 在 <code>HTTP</code> 中是无效,在 <code>HTTPS</code>中才有效</td>
</tr>
<tr>
<td align="center">7</td>
<td align="left"><code>signed</code></td>
<td><code>Boolean</code></td>
<td>表示是否签名<code>cookie</code>,如果设置为<code>true</code>的时候表示对这个<code>cookie</code>签名了,这样就需要用<code>res.signedCookies()</code>获取值<code>cookie</code>不是使用<code>res.cookies()</code>了,</td>
</tr>
</tbody></table>
<ul>
<li><p>7、签名<code>cookie</code>的设置</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts中</span></span><br><span class="line">app.use(cookieParser(process.env.SECRET)); <span class="comment">// 配合dotenv包来使用</span></span><br><span class="line"><span class="string">``</span><span class="string">`c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>typescript</span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Response, Request &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  index(<span class="meta">@Request</span>() req) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.signedCookies, <span class="string">'当前的cookie'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'主页'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">'login'</span>)</span><br><span class="line">  login(<span class="meta">@Response</span>() res) &#123;</span><br><span class="line">    <span class="comment">// 如果使使用了res就不能使用return，必须使用send</span></span><br><span class="line">    <span class="comment">// res.cookie('name', 'hello', &#123; maxAge: 1000 * 5, httpOnly: true &#125;);</span></span><br><span class="line">    res.cookie(<span class="string">'name'</span>, <span class="string">'hello'</span>, &#123; maxAge: <span class="number">1000</span> * <span class="number">5</span>, httpOnly: <span class="literal">true</span>, signed: <span class="literal">true</span> &#125;)</span><br><span class="line">    res.send(<span class="string">'登录页面'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>8、如果要销毁<code>cookie</code>常见的方式</p>
<ul>
<li>直接将值设置为空</li>
<li>设置<code>maxAge=0</code></li>
</ul>
</li>
<li><p>9、<a href="https://github.com/kuangshp/nest-book-code/tree/08.cookie" target="_blank" rel="noopener">本小节代码</a></p>
</li>
</ul>
<h2 id="四、Nestjs中使用session"><a href="#四、Nestjs中使用session" class="headerlink" title="四、Nestjs中使用session"></a>四、<code>Nestjs中使用session</code></h2><ul>
<li><p>1、<strong><code>session</code></strong> 是另一种记录客户状态的机制，不同的是 <strong><code>Cookie</code></strong> 保存在客户端浏览器中，而 <strong><code>session</code></strong> 保存 在服务器上</p>
</li>
<li><p>2、<code>session</code>的工作流程<br>当浏览器访问服务器并发送第一次请求的时候,服务器端会创建一个<code>session</code>对象,生成一个类似于<code>{key: &#39;&#39;, value: &#39;&#39;}</code>的对象,然后将<code>key(cookie)</code>返回到浏览器(客户)端,浏览器再次访问的时候携带这个<code>key(cookie)</code>到服务器端,找到这个<code>session</code>的<code>value</code>值。</p>
</li>
<li><p>3、在<code>nestjs</code>中使用<code>express-session</code>进行<code>session</code>的操作</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install express-session</span><br><span class="line">npm install <span class="meta">@types</span>/express-session -D</span><br></pre></td></tr></table></figure></li>
<li><p>4、在<code>main.ts</code>中配置<code>session</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NestFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> session <span class="keyword">from</span> <span class="string">'express-session'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">  <span class="comment">// 配置中间件使用session,加盐是123456(随便写的)</span></span><br><span class="line">  app.use(session(&#123; secret: <span class="string">'123456'</span>, cookie: &#123; maxAge: <span class="number">60000</span> &#125; &#125;))</span><br><span class="line">  <span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure></li>
<li><p>5、创建<code>user</code>的模块及控制器(忽视请求方式,只是方便浏览器模拟请求)</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Request, Response &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'user'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> UserController &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  index(</span><br><span class="line">    <span class="meta">@Request</span>() req: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">any</span> &#125;</span><br><span class="line">  ): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.session);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'用户主页'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">'login'</span>)</span><br><span class="line">  login(</span><br><span class="line">    <span class="meta">@Response</span>() res: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">any</span> &#125;,</span><br><span class="line">    <span class="meta">@Request</span>() req: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">any</span> &#125;</span><br><span class="line">  ): <span class="built_in">void</span> &#123;</span><br><span class="line">    req.session.name = <span class="string">'hello'</span>;</span><br><span class="line">    <span class="comment">// 再次提醒使用了@Response就不能使用return</span></span><br><span class="line">    res.send(<span class="string">'登录页面'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>6、先在浏览器中访问<code>localhost:3000/user/login</code>然后访问<code>localhost:3000/user</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑器控制图打印出信息,可以获取到刚刚设置的session</span></span><br><span class="line">Session &#123;</span><br><span class="line">  cookie: &#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    _expires: <span class="number">2020</span><span class="number">-07</span><span class="number">-27</span>T09:<span class="number">28</span>:<span class="number">20.046</span>Z,</span><br><span class="line">    originalMaxAge: <span class="number">60000</span>,</span><br><span class="line">    httpOnly: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  name: <span class="string">'hello'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>7、常见参数的说明</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>NO</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><code>secret</code></td>
<td>一个 <code>String</code> 类型的字符串，作为服务器端生成<code>session</code> 的签名</td>
</tr>
<tr>
<td>2</td>
<td><code>name</code></td>
<td>返回客户端的<code>key</code> 的名称，默认为<code>connect.sid</code>,也可以自己设置</td>
</tr>
<tr>
<td>3</td>
<td><code>resave</code></td>
<td>强制保存 <code>session</code>即使它并没有变化,。默认为<code>true</code>。建议设置成 <code>false</code></td>
</tr>
<tr>
<td>4</td>
<td><code>saveUninitalized</code></td>
<td>强制将未初始化的 <code>session</code> 存储。当新建了一个 <code>session</code> 且未设定属性或值时，它就处于 未初始化状态。在设定一个 <code>cookie</code> 前，这对于登陆验证，减轻服务端存储压力，权限控制是有帮助的。( 默认:<code>true</code>)。建议手动添加</td>
</tr>
<tr>
<td>5</td>
<td><code>cookie</code></td>
<td>设置返回到前端<code>key</code> 的属性，默认值为<code>{ path: ‘/’, httpOnly: true, secure: false, maxAge: null }</code>。</td>
</tr>
<tr>
<td>6</td>
<td><code>rolling</code></td>
<td>在每次请求时强行设置 <code>cookie</code>，这将重置<code>cookie</code> 过期时间(默认:<code>false</code>)</td>
</tr>
</tbody></table>
<ul>
<li><p>8、<code>session</code>的销毁</p>
</li>
<li><p>设置<code>maxAge=0</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.session.cookie.maxAge=<span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将值设置为空</p>
</li>
<li><p>使用<code>destroy</code>销毁方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">req.session.destroy(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>9、<a href="https://github.com/kuangshp/nest-book-code/tree/09.session" target="_blank" rel="noopener">本小节代码地址</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://suzhihui.github.io/2020/09/01/nestjs-%E4%BA%8C/" data-id="ckowlt6nk00175cu5bw1cbi96" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nestjs/" rel="tag">nestjs</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/03/nestjs-%E4%B8%89/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nestjs(三)
        
      </div>
    </a>
  
  
    <a href="/2020/08/30/nestjs-%E4%B8%80/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">nestjs(一)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E4%BD%9C/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/" rel="tag">electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nestjs/" rel="tag">nestjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" rel="tag">前端架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%85%A7%E6%9D%A5%E5%AE%A2/" rel="tag">慧来客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/electron/" style="font-size: 10px;">electron</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nestjs/" style="font-size: 17.5px;">nestjs</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/vue/" style="font-size: 12.5px;">vue</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" style="font-size: 15px;">前端架构</a> <a href="/tags/%E6%85%A7%E6%9D%A5%E5%AE%A2/" style="font-size: 10px;">慧来客</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 20px;">正则表达式</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/22/electron/">electron</a>
          </li>
        
          <li>
            <a href="/2021/04/12/git%E9%AB%98%E7%BA%A7/">git 高级</a>
          </li>
        
          <li>
            <a href="/2021/01/13/npm-%E5%85%A8%E5%B1%80%E5%AE%89%E8%A3%85%E8%B7%AF%E5%BE%84%E4%BF%AE%E6%94%B9/">npm 全局安装路径修改</a>
          </li>
        
          <li>
            <a href="/2020/09/09/nestjs-%E4%BA%94/">nestjs(五)</a>
          </li>
        
          <li>
            <a href="/2020/09/08/nestjs-%E5%9B%9B/">nestjs(四)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 laosu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>